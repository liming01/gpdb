-- @Description Tests retrieve session functionality restriction for security.
--
DROP TABLE IF EXISTS t1;
DROP
CREATE TABLE t1 (a INT) DISTRIBUTED by (a);
CREATE
insert into t1 select generate_series(1,100);
INSERT 100

CREATE OR REPLACE FUNCTION myappend(anyarray, anyelement) RETURNS anyarray AS $$ SELECT $1 || $2 $$ LANGUAGE SQL;
CREATE

-- Test: Retrieve login without valid token.
1: @in_sh 'export RETRIEVE_TOKEN="123" ; echo $RAW_STR' : SELECT 1;
 ?column? 
----------
 1        
(1 row)
0R: SELECT 1;
#0retrieve> FATAL:  Retrieve auth token is invalid


-- Test: Declare a cursor
1: BEGIN;
BEGIN
1: DECLARE c1 PARALLEL RETRIEVE CURSOR FOR SELECT * FROM t1;
DECLARE
1: @out_sh 'parse_endpoint 1 1 2 3 4' : SELECT endpointname,token,hostname,port,status FROM gp_endpoints_info(true) WHERE cursorname='c1';
 endpoint_id1_1 | token_id | host_id | port_id | READY
 endpoint_id1_2 | token_id | host_id | port_id | READY
 endpoint_id1_3 | token_id | host_id | port_id | READY
(3 rows)

-- Test: Should not change gp_session_role and gp_role in retrieve mode
0R: set gp_session_role to 'utility';
ERROR:  parameter "gp_session_role" cannot be set after connection start
0R: set gp_role to 'utility';
ERROR:  "gp_role" could not be changed from retrieve role

-- Test: limit all statement which is supported in utility sesssion
0R: show gp_session_role;
 gp_session_role 
-----------------
 retrieve        
(1 row)

0R: begin;
BEGIN
0R: declare c1 cursor for select * from t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: fetch 5 from c1;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
0R: rollback;
ROLLBACK

0R: delete FROM t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: insert into t1 select generate_series(100,110);
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: update t1 set a=a+100 where a<10;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: truncate table t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
-- web external table is also disallowed by this restriction.
0R: select * from t1;
ERROR:  Only gp_endpoints view can be accessed by retrieve role

0R: CREATE TABLE t10 (a INT) DISTRIBUTED by (a);
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: DROP TABLE t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role

-- copy ... on program ... is also disallowed by this restriction.
0R: COPY t1 to '/tmp/1.cvs';
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role

-- Test: builtin function can be allowed
0R: select '12'::int;
 int4 
------
 12   
(1 row)
-- Test: UDF can not be allowed
0R: SELECT myappend(ARRAY[42,6], 21);
ERROR:  Only builtin functions can be called for retrieve role (aclchk.c:5068)
-- Test: Create UDF can not allowed
0R: CREATE OR REPLACE FUNCTION myappend1(anyarray, anyelement) RETURNS anyarray AS $$ SELECT $1 || $2 $$ LANGUAGE SQL;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role

-- Test: Different illegal tokens always lead to a same general message
---- Illegal tokens
1R: RETRIEVE ALL FROM ENDPOINT abc;
ERROR:  failed to attach non-existing endpoint abc (cdbendpointretrieve.c:LINENO)
1R: RETRIEVE ALL FROM ENDPOINT 123;
ERROR:  syntax error at or near "123"
LINE 1: RETRIEVE ALL FROM ENDPOINT 123;
                                   ^
1R: RETRIEVE ALL FROM ENDPOINT tk1122;
ERROR:  failed to attach non-existing endpoint tk1122 (cdbendpointretrieve.c:LINENO)
1R: RETRIEVE ALL FROM ENDPOINT tktt223344556677889900112233445566;
ERROR:  failed to attach non-existing endpoint tktt223344556677889900112233445566 (cdbendpointretrieve.c:LINENO)

-- Retrieve data.
*R: @in_sh 'sub_endpoint_name @ENDPOINT1': RETRIEVE 10 FROM ENDPOINT "@ENDPOINT1";
#-1retrieve> FATAL:  Retrieve auth token is invalid


 a  
----
 16 
 18 
 19 
 2  
 22 
 24 
 3  
 4  
 7  
 8  
(10 rows)

 a  
----
 1  
 12 
 15 
 20 
 23 
 26 
 30 
 31 
 35 
 36 
(10 rows)

 a  
----
 10 
 11 
 13 
 14 
 17 
 21 
 25 
 5  
 6  
 9  
(10 rows)
