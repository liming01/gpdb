-- @Description Tests retrieve session functionality restriction for security.
--
DROP TABLE IF EXISTS t1;
DROP
CREATE TABLE t1 (a INT);
CREATE
insert into t1 select generate_series(1,100);
INSERT 100

CREATE OR REPLACE FUNCTION myappend(anyarray, anyelement) RETURNS anyarray AS $$
SELECT $1 || $2
$$ LANGUAGE SQL;
CREATE

-- Test: Should not change gp_session_role and gp_role in retrieve mode
0R: set gp_session_role to 'utility';
ERROR:  parameter "gp_session_role" cannot be set after connection start
0R: set gp_role to 'utility';
ERROR:  "gp_role" could not be changed from retrieve role

-- Test: limit all statement which is supported in utility sesssion
0R: show gp_session_role;
 gp_session_role 
-----------------
 retrieve        
(1 row)

0R: begin;
BEGIN
0R: declare c1 cursor for select * from t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: fetch 5 from c1;
ERROR:  current transaction is aborted, commands ignored until end of transaction block
0R: rollback;
ROLLBACK

0R: delete FROM t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: insert into t1 select generate_series(100,110);
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: update t1 set a=a+100 where a<10;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: truncate table t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
-- web external table is also disallowed by this restriction.
0R: select * from t1;
ERROR:  Only gp_endpoints view can be accessed by retrieve role

0R: CREATE TABLE t10 (a INT);
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
0R: DROP TABLE t1;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role

-- copy ... on program ... is also disallowed by this restriction.
0R: COPY t1 to '/tmp/1.cvs';
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role

-- Test: builtin function can be allowed
0R: select '12'::int;
 int4 
------
 12   
(1 row)
-- Test: UDF can not be allowed
0R: SELECT myappend(ARRAY[42,6], 21);
ERROR:  Only builtin functions can be called for retrieve role (aclchk.c:5055)
-- Test: Create UDF can not allowed
0R: CREATE OR REPLACE FUNCTION myappend1(anyarray, anyelement) RETURNS anyarray AS $$
SELECT $1 || $2
$$ LANGUAGE SQL;
ERROR:  Only allow RETRIEVE, SELECT, transaction and GUC statements for retrieve role
